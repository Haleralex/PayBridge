name: Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
        cache: true

    - name: Run unit tests
      run: |
        echo "Running unit tests (without integration tag)..."
        go test -v -race -coverprofile=coverage_unit.out -covermode=atomic ./internal/application/usecases/transaction/...
        echo ""
        echo "Unit Test Coverage:"
        go tool cover -func coverage_unit.out

    - name: Upload unit test coverage
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage_unit.out
        flags: unit
        name: unit-tests
      continue-on-error: true

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: wallethub_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
        cache: true

    - name: Wait for PostgreSQL
      run: |
        until pg_isready -h localhost -p 5432 -U postgres; do
          echo "Waiting for postgres..."
          sleep 2
        done

    - name: Run migrations
      env:
        PGPASSWORD: postgres
      run: |
        echo "=== MIGRATION STEP START ==="
        pwd
        ls -la migrations/
        
        echo "=== APPLYING MIGRATIONS ==="
        psql -h localhost -U postgres -d wallethub_test -f migrations/000001_create_users.up.sql
        psql -h localhost -U postgres -d wallethub_test -f migrations/000002_create_wallets.up.sql
        psql -h localhost -U postgres -d wallethub_test -f migrations/000003_create_transactions.up.sql
        psql -h localhost -U postgres -d wallethub_test -f migrations/000004_create_outbox.up.sql
        psql -h localhost -U postgres -d wallethub_test -f migrations/000005_add_telegram_id.up.sql
        
        echo "=== MIGRATIONS APPLIED ==="

    - name: Run integration tests
      env:
        TEST_DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/wallethub_test?sslmode=disable"
      run: |
        echo "Running integration tests (with real PostgreSQL)..."
        go test -tags=integration -v -race -coverprofile=coverage_integration.out -covermode=atomic ./internal/application/usecases/transaction/...

    - name: Display coverage
      run: |
        echo "Integration Test Coverage:"
        go tool cover -func coverage_integration.out | tail -20

    - name: Upload integration test coverage
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage_integration.out
        flags: integration
        name: integration-tests
      continue-on-error: true

  all-tests:
    name: All Tests Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
    - name: Summary
      run: |
        echo "âœ… All tests passed successfully!"
        echo "Unit tests: ~5s"
        echo "Integration tests: ~10s"
        echo "Total CI time: ~15-20s (parallel execution)"
